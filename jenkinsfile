def dockerImage() {
    echo(message: 'building the docker image...')
    withCredentials([usernamePassword(credentialsId: 'ci-docker', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
        sh 'docker build -t dimenssion/build:smile .'
        sh "docker login -u ${USERNAME} -p ${PASSWORD}"
        sh 'docker pull dimenssion/build:smile'
    }
}

def dockerRm() {
    /* sh "docker rmi $registry:$BUILD_NUMBER" */
    sh 'docker system prune -af'
}


properties([disableConcurrentBuilds(), pipelineTriggers([githubPush()])])

pipeline {

    agent any

    environment {
        registry = 'dimenssion/build'
        registryCredential = 'build-lamp-ssh'
        dockerTag = ':lts'
        credentialsId = 'build-lamp-ssh'
    }

    triggers { pollSCM('* * * * *') }
        options {
            buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
            timestamps()
        }

    stages {
        /* checkout repo */
        stage('Checkout SCM') {
            steps {
                checkout([
                 $class: 'GitSCM',
                 branches: [[name: 'master']],
                 userRemoteConfigs: [[
                    url: 'git@github.com:dimension-hub/docker-lamp.git',
                    credentialsId: credentialsId,
                 ]]
                ])
            }
        }
    }
    /* Cleanup workspace */
    post {
        always {
                dockerImage()
                dockerRm()
            }
    }

}
